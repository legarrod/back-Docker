pipeline {
    agent any
    
    parameters {
        string(name: 'DOCKER_TAG', defaultValue: 'latest', description: 'Docker tag for the image')
        choice(name: 'ENVIRONMENT', choices: ['development', 'staging', 'production'], description: 'Deployment environment')
        booleanParam(name: 'SKIP_TESTS', defaultValue: false, description: 'Skip unit tests')
        booleanParam(name: 'SKIP_INTEGRATION_TESTS', defaultValue: false, description: 'Skip integration tests')
        booleanParam(name: 'FORCE_DEPLOY', defaultValue: false, description: 'Force deployment even if tests fail')
    }
    
    tools {
        nodejs 'NodeJS-18'
    }
    
    environment {
        DOCKER_IMAGE = "backend-app"
        DOCKER_TAG = "${params.DOCKER_TAG ?: 'latest'}"
        NODE_ENV = "${params.ENVIRONMENT ?: 'development'}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "üîÑ Checking out code..."
                checkout scm
                sh 'ls -la'
                sh 'echo "Repository checked out successfully"'
            }
        }
        
        stage('Environment Info') {
            steps {
                echo "üìã Environment Information"
                sh '''
                    echo "Node version: $(node --version)"
                    echo "NPM version: $(npm --version)"
                    echo "Docker version: $(docker --version)"
                    echo "Environment: ${NODE_ENV}"
                    echo "Docker tag: ${DOCKER_TAG}"
                '''
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo "üì¶ Installing dependencies..."
                script {
                    // M√©todo robusto para instalar dependencias
                    sh '''
                        echo "Cleaning npm cache..."
                        npm cache clean --force
                        
                        echo "Removing existing node_modules and lock file..."
                        rm -rf node_modules package-lock.json
                        
                        echo "Installing dependencies..."
                        npm install
                        
                        echo "Dependencies installed successfully!"
                        ls -la node_modules/ | head -10
                    '''
                }
            }
        }
        
        stage('Code Quality & Linting') {
            when {
                not { params.SKIP_TESTS == true }
            }
            steps {
                echo "üîç Running code quality checks..."
                script {
                    // Solo ejecutar si existen los scripts
                    sh '''
                        if grep -q '"lint"' package.json; then
                            echo "Running linting..."
                            npm run lint || echo "Linting failed but continuing..."
                        else
                            echo "No lint script found, skipping..."
                        fi
                    '''
                }
            }
        }
        
        stage('Unit Tests') {
            when {
                not { params.SKIP_TESTS == true }
            }
            steps {
                echo "üß™ Running unit tests..."
                script {
                    sh '''
                        if grep -q '"test"' package.json; then
                            echo "Running tests..."
                            npm test || {
                                echo "Tests failed!"
                                if [ "${FORCE_DEPLOY}" = "true" ]; then
                                    echo "FORCE_DEPLOY is true, continuing despite test failures..."
                                else
                                    exit 1
                                fi
                            }
                        else
                            echo "No test script found, skipping tests..."
                        fi
                    '''
                }
            }
        }
        
        stage('Integration Tests') {
            when {
                allOf {
                    not { params.SKIP_INTEGRATION_TESTS == true }
                    anyOf {
                        equals expected: 'staging', actual: params.ENVIRONMENT
                        equals expected: 'production', actual: params.ENVIRONMENT
                    }
                }
            }
            steps {
                echo "üîó Running integration tests..."
                script {
                    sh '''
                        if grep -q '"test:integration"' package.json; then
                            echo "Running integration tests..."
                            npm run test:integration || {
                                echo "Integration tests failed!"
                                if [ "${FORCE_DEPLOY}" = "true" ]; then
                                    echo "FORCE_DEPLOY is true, continuing..."
                                else
                                    exit 1
                                fi
                            }
                        else
                            echo "No integration test script found, skipping..."
                        fi
                    '''
                }
            }
        }
        
        stage('Build Application') {
            steps {
                echo "üèóÔ∏è Building application..."
                script {
                    sh '''
                        if grep -q '"build"' package.json; then
                            echo "Building application..."
                            npm run build
                        else
                            echo "No build script found, skipping build step..."
                        fi
                    '''
                }
            }
        }
        
        stage('Docker Build') {
            steps {
                echo "üê≥ Building Docker image..."
                script {
                    sh '''
                        echo "Building Docker image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                        docker build \
                            --build-arg NODE_ENV=${NODE_ENV} \
                            --build-arg BUILD_NUMBER=${BUILD_NUMBER} \
                            -t ${DOCKER_IMAGE}:${DOCKER_TAG} \
                            -t ${DOCKER_IMAGE}:build-${BUILD_NUMBER} \
                            .
                        
                        echo "Docker image built successfully!"
                        docker images | grep ${DOCKER_IMAGE}
                    '''
                }
            }
        }
        
        stage('Docker Test') {
            steps {
                echo "üß™ Testing Docker image..."
                script {
                    sh '''
                        echo "Testing Docker container..."
                        
                        # Verificar que la imagen se ejecuta correctamente
                        docker run --rm ${DOCKER_IMAGE}:${DOCKER_TAG} echo "Container test successful!"
                        
                        # Si hay un health check, ejecutarlo
                        if docker inspect ${DOCKER_IMAGE}:${DOCKER_TAG} | grep -q "Healthcheck"; then
                            echo "Running health check..."
                            docker run --rm -d --name test-container ${DOCKER_IMAGE}:${DOCKER_TAG}
                            sleep 10
                            docker stop test-container || true
                        fi
                    '''
                }
            }
        }
        
        stage('Deploy to Environment') {
            when {
                anyOf {
                    equals expected: 'staging', actual: params.ENVIRONMENT
                    equals expected: 'production', actual: params.ENVIRONMENT
                }
            }
            steps {
                echo "üöÄ Deploying to ${params.ENVIRONMENT}..."
                script {
                    if (params.ENVIRONMENT == 'production') {
                        input message: 'Deploy to production?', ok: 'Deploy',
                              submitterParameter: 'DEPLOYER'
                    }
                    
                    sh '''
                        echo "Deploying ${DOCKER_IMAGE}:${DOCKER_TAG} to ${ENVIRONMENT}"
                        
                        # Aqu√≠ ir√≠an los comandos espec√≠ficos de deploy
                        # Por ejemplo, actualizar docker-compose, kubernetes, etc.
                        
                        echo "Deployment to ${ENVIRONMENT} completed!"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo "üßπ Cleaning up..."
            script {
                sh '''
                    # Mantener solo las √∫ltimas 5 im√°genes
                    OLD_IMAGES=$(docker images ${DOCKER_IMAGE} --format "{{.Tag}}" | grep "^build-" | sort -nr | tail -n +6)
                    if [ ! -z "$OLD_IMAGES" ]; then
                        echo "Removing old images: $OLD_IMAGES"
                        echo "$OLD_IMAGES" | xargs -I {} docker rmi ${DOCKER_IMAGE}:{} || true
                    fi
                '''
            }
        }
        
        success {
            echo "‚úÖ Pipeline completed successfully!"
            script {
                if (params.ENVIRONMENT == 'production') {
                    echo "üéâ Production deployment successful!"
                }
            }
        }
        
        failure {
            echo "‚ùå Pipeline failed!"
        }
        
        unstable {
            echo "‚ö†Ô∏è Pipeline completed with warnings"
        }
        
        cleanup {
            echo "Cleaning workspace..."
            script {
                sh 'docker system prune -f --volumes || true'
            }
        }
    }
}